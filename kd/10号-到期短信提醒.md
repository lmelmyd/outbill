# 宽带到期短信提醒

10号和20号执行

## 定时间任务，每月10号和20号执行

```
00 9 10,20 * * /drecvdata/drecv1/remind_adsl/run_send_sms_new.sh
```

## 检查执行状态

```
drecv1主机
ls ~/remind_adsl/*.ctl
#无 *sms* 的为结束
```

## 库内查看执行状态

```
--bss 4个域
SELECT remark, COUNT(1)
  FROM Tf_f_Broad_Warn_New_sms
 WHERE update_day = to_char(SYSDATE - 1, 'yyyymmdd')
 GROUP BY remark;
--cbss kfk 组合查看
SELECT remark, COUNT(1)
  FROM cbss_broad_warn_new_sms
 WHERE update_day = to_char(SYSDATE - 1, 'yyyymmdd')
 GROUP BY remark;
--cbss kfk 共享查看
SELECT remark, COUNT(1)
  FROM ad_cbss_kddq_share_sms
 WHERE update_day = to_char(SYSDATE - 1, 'yyyymmdd')
 GROUP BY remark;
```

remark = "ok" 表示发送的数据量

## 发送短信
### bss发送

```sql
 --1，2，3，4域执行
 --id_tag='0'
 INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || serial_number ||
            '），该账户剩余使用费预计将于本月使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM (SELECT tb.Action_Rule_Id, tb.Action_Rule_Name, a.*
               FROM Tf_f_Broad_Warn_New_sms a,
                    (SELECT a.action_code, b.action_rule_id, b.Action_Rule_Name
                        FROM Td_b_Discnt_action_comp a, Td_b_Discnt_action_rule b
                       WHERE a.Exec_Id = b.Action_Rule_Id
                         AND a.Exec_Type = '1') tb
              WHERE id_tag = '0'
                AND remark = 'ok'
                AND a.Update_Day = to_char(SYSDATE - 1, 'yyyymmdd')
                AND a.Action_Code = tb.action_code);

--id_tag='1'
INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || serial_number ||
            '），该账户剩余使用费预计将于1个月后使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM (SELECT tb.Action_Rule_Id, tb.Action_Rule_Name, a.*
               FROM Tf_f_Broad_Warn_New_sms a,
                    (SELECT a.action_code, b.action_rule_id, b.Action_Rule_Name
                        FROM Td_b_Discnt_action_comp a, Td_b_Discnt_action_rule b
                       WHERE a.Exec_Id = b.Action_Rule_Id
                         AND a.Exec_Type = '1') tb
              WHERE id_tag = '1'
                AND remark = 'ok'
                AND a.Update_Day = to_char(SYSDATE - 1, 'yyyymmdd')
                AND a.Action_Code = tb.action_code);

--id_tag='2'
INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || serial_number ||
            '），该账户剩余使用费预计将于2个月后使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM (SELECT tb.Action_Rule_Id, tb.Action_Rule_Name, a.*
               FROM Tf_f_Broad_Warn_New_sms a,
                    (SELECT a.action_code, b.action_rule_id, b.Action_Rule_Name
                        FROM Td_b_Discnt_action_comp a, Td_b_Discnt_action_rule b
                       WHERE a.Exec_Id = b.Action_Rule_Id
                         AND a.Exec_Type = '1') tb
              WHERE id_tag = '2'
                AND remark = 'ok'
                AND a.Update_Day = to_char(SYSDATE - 1, 'yyyymmdd')
                AND a.Action_Code = tb.action_code);
--注意提交
```

### cbss发送

```sql
--各域执行

--短信
INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || serial_number ||
            '），该账户剩余使用费预计将于本月使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM yl_act_it5.cbss_broad_warn_new_sms@TO_KFK_ACT a
     WHERE id_tag = '0'
       AND remark = 'ok'
       AND a.Update_Day = to_char(SYSDATE - 1, 'yyyymmdd')
       AND eparchy_code IN (SELECT eparchy_code
                              FROM td_b_local_commpara
                             WHERE para_attr = '14');

INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || serial_number ||
            '），该账户剩余使用费预计将于1个月后使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM yl_act_it5.cbss_broad_warn_new_sms@TO_KFK_ACT a
     WHERE id_tag = '1'
       AND remark = 'ok'
       AND a.Update_Day = to_char(sysdate-1,'yyyymmdd')
       AND eparchy_code IN (SELECT eparchy_code
                              FROM td_b_local_commpara
                             WHERE para_attr = '14');

INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || serial_number ||
            '），该账户剩余使用费预计将于2个月后使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM yl_act_it5.cbss_broad_warn_new_sms@TO_KFK_ACT a
     WHERE id_tag = '2'
       AND remark = 'ok'
       AND a.Update_Day = to_char(sysdate-1,'yyyymmdd')
       AND eparchy_code IN (SELECT eparchy_code
                              FROM td_b_local_commpara
                             WHERE para_attr = '14');


--共享
--短信
INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || ad_serial_number ||
            '），该账户剩余使用费预计将于本月使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM yl_act_it5.ad_cbss_kddq_share_sms@TO_KFK_ACT a
     WHERE id_tag = '0'
       AND remark = 'ok'
       AND a.Update_Day = to_char(sysdate-1,'yyyymmdd')
       AND eparchy_code IN (SELECT eparchy_code
                              FROM td_b_local_commpara
                             WHERE para_attr = '14');

INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || ad_serial_number ||
            '），该账户剩余使用费预计将于1个月后使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM yl_act_it5.ad_cbss_kddq_share_sms@TO_KFK_ACT a
     WHERE id_tag = '1'
       AND remark = 'ok'
       AND a.Update_Day = to_char(sysdate-1,'yyyymmdd')
       AND eparchy_code IN (SELECT eparchy_code
                              FROM td_b_local_commpara
                             WHERE para_attr = '14');

INSERT INTO ti_o_sms
    (sms_notice_id, eparchy_code, in_mode_code, sms_channel_code, recv_object_type,
     recv_object, id, sms_type_code, sms_kind_code, notice_content_type, notice_content,
     force_refer_count, sms_priority, refer_time, refer_staff_id, refer_depart_id,
     deal_state, send_object_code, send_time_code, send_count_code, deal_time, revc4)
    SELECT f_uip_getseqid('seq_smssend_id'), eparchy_code, '0', '28', '00', mobile_number,
           mob_user_id, '01', '01', '0',
           '尊敬的客户，您好！随您手机号码一同办理的宽带业务（' || ad_serial_number ||
            '），该账户剩余使用费预计将于2个月后使用完毕，为了不影响您的正常使用，请您及时到就近联通营业厅进行缴费，谢谢！', 1, 9999, SYSDATE,
           'CREDIT00', 'CREDI', '0', 2, 1, 1, to_date('20500101', 'yyyymmdd'), 'kd专款到期'
      FROM yl_act_it5.ad_cbss_kddq_share_sms@TO_KFK_ACT a
     WHERE id_tag = '2'
       AND remark = 'ok'
       AND a.Update_Day = to_char(sysdate-1,'yyyymmdd')
       AND eparchy_code IN (SELECT eparchy_code
                              FROM td_b_local_commpara
                             WHERE para_attr = '14');
```



